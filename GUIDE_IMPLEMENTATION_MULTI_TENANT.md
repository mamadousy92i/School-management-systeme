# üöÄ Guide d'Impl√©mentation Multi-Tenant - √âtape par √âtape

## ‚úÖ PHASE 1 : Mod√®le √âcole (TERMIN√â)

Le mod√®le `Ecole` a √©t√© cr√©√© dans `backend/academic/models.py` avec :
- ‚úÖ Informations de base (nom, code, directrice)
- ‚úÖ Contact (adresse, t√©l√©phone, email)  
- ‚úÖ Branding (logo, devise)
- ‚úÖ Gestion d'abonnement SaaS
- ‚úÖ Limites par √©cole

---

## üìã PHASE 2 : Ajout du Lien √âcole ‚Üí User

### √âtape 2.1 : Modifier le Mod√®le User

**Fichier** : `backend/users/models.py`

```python
# Ajouter ce champ dans la classe User
ecole = models.ForeignKey(
    'academic.Ecole',
    on_delete=models.CASCADE,
    related_name='users',
    null=True,  # Temporaire pour la migration
    blank=True,
    verbose_name="√âcole"
)

def get_ecole(self):
    """R√©cup√®re l'√©cole de l'utilisateur"""
    return self.ecole
```

---

## üìã PHASE 3 : Cr√©er les Migrations

### √âtape 3.1 : Cr√©er les Migrations Initiales

```bash
cd backend
python manage.py makemigrations academic
python manage.py makemigrations users
```

### √âtape 3.2 : Appliquer les Migrations

```bash
python manage.py migrate
```

---

## üìã PHASE 4 : Cr√©er l'√âcole par D√©faut

### √âtape 4.1 : Cr√©er un Script de Migration des Donn√©es

**Fichier** : `backend/create_default_ecole.py`

```python
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
django.setup()

from academic.models import Ecole
from users.models import User

# 1. Cr√©er l'√©cole par d√©faut
ecole, created = Ecole.objects.get_or_create(
    code='ECOLE001',
    defaults={
        'nom': '√âcole Primaire S√©n√©galaise',
        'directrice': 'Mme Fatou SARR',
        'devise': 'Excellence, Discipline, R√©ussite',
        'adresse': 'Dakar, S√©n√©gal',
        'telephone': '+221 33 XXX XX XX',
        'email': 'contact@ecole.sn',
        'abonnement_actif': True,
        'max_eleves': 1000,
        'max_professeurs': 100,
    }
)

if created:
    print(f"‚úÖ √âcole cr√©√©e : {ecole}")
else:
    print(f"‚ÑπÔ∏è  √âcole existante : {ecole}")

# 2. Assigner tous les utilisateurs existants √† cette √©cole
users_updated = User.objects.filter(ecole__isnull=True).update(ecole=ecole)
print(f"‚úÖ {users_updated} utilisateurs assign√©s √† l'√©cole")

print("\nüéâ Migration termin√©e !")
```

### √âtape 4.2 : Ex√©cuter le Script

```bash
python backend/create_default_ecole.py
```

---

## üìã PHASE 5 : Ajouter ecole_id √† TOUS les Mod√®les

### Mod√®les √† Modifier

**Fichier** : `backend/academic/models.py`

```python
# AnneeScolaire
class AnneeScolaire(models.Model):
    libelle = models.CharField(max_length=20)
    # AJOUTER :
    ecole = models.ForeignKey(
        Ecole, 
        on_delete=models.CASCADE,
        related_name='annees_scolaires',
        null=True  # Temporaire
    )

# Classe
class Classe(models.Model):
    nom = models.CharField(max_length=100)
    # AJOUTER :
    ecole = models.ForeignKey(
        Ecole,
        on_delete=models.CASCADE,
        related_name='classes',
        null=True  # Temporaire
    )

# Matiere
class Matiere(models.Model):
    nom = models.CharField(max_length=100)
    # AJOUTER :
    ecole = models.ForeignKey(
        Ecole,
        on_delete=models.CASCADE,
        related_name='matieres',
        null=True  # Temporaire
    )

# Eleve
class Eleve(models.Model):
    nom = models.CharField(max_length=100)
    # AJOUTER :
    ecole = models.ForeignKey(
        Ecole,
        on_delete=models.CASCADE,
        related_name='eleves',
        null=True  # Temporaire
    )
```

**Fichier** : `backend/users/models.py`

```python
# Professeur
class Professeur(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    # AJOUTER :
    ecole = models.ForeignKey(
        'academic.Ecole',
        on_delete=models.CASCADE,
        related_name='professeurs',
        null=True  # Temporaire
    )
```

**Fichier** : `backend/grades/models.py`

```python
# Periode
class Periode(models.Model):
    nom = models.CharField(max_length=50)
    # AJOUTER :
    ecole = models.ForeignKey(
        'academic.Ecole',
        on_delete=models.CASCADE,
        related_name='periodes',
        null=True  # Temporaire
    )

# TypeEvaluation (si applicable)
# Note, Moyenne, etc.
```

---

## üìã PHASE 6 : Migrations apr√®s Ajout des Champs

### √âtape 6.1 : Cr√©er les Migrations

```bash
python manage.py makemigrations
```

### √âtape 6.2 : Assigner l'√âcole par D√©faut

**Fichier** : `backend/assign_ecole_to_all.py`

```python
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
django.setup()

from academic.models import Ecole, AnneeScolaire, Classe, Matiere, Eleve
from users.models import Professeur
from grades.models import Periode

# R√©cup√©rer l'√©cole par d√©faut
ecole = Ecole.objects.get(code='ECOLE001')

# Assigner √† tous les objets existants
AnneeScolaire.objects.filter(ecole__isnull=True).update(ecole=ecole)
Classe.objects.filter(ecole__isnull=True).update(ecole=ecole)
Matiere.objects.filter(ecole__isnull=True).update(ecole=ecole)
Eleve.objects.filter(ecole__isnull=True).update(ecole=ecole)
Professeur.objects.filter(ecole__isnull=True).update(ecole=ecole)
Periode.objects.filter(ecole__isnull=True).update(ecole=ecole)

print("‚úÖ Toutes les donn√©es assign√©es √† l'√©cole par d√©faut")
```

### √âtape 6.3 : Ex√©cuter le Script

```bash
python backend/assign_ecole_to_all.py
```

### √âtape 6.4 : Rendre les Champs Obligatoires

Modifier TOUS les mod√®les pour retirer `null=True` :

```python
ecole = models.ForeignKey(
    Ecole,
    on_delete=models.CASCADE,
    related_name='classes'
    # Plus de null=True !
)
```

### √âtape 6.5 : Nouvelle Migration

```bash
python manage.py makemigrations
python manage.py migrate
```

---

## üìã PHASE 7 : Middleware de Cloisonnement

**Fichier** : `backend/core/middleware.py` (CR√âER)

```python
class TenantMiddleware:
    """
    Middleware qui injecte automatiquement l'√©cole de l'utilisateur
    """
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        if request.user.is_authenticated and hasattr(request.user, 'ecole'):
            request.ecole = request.user.ecole
        else:
            request.ecole = None
        
        response = self.get_response(request)
        return response
```

**Fichier** : `backend/core/settings.py`

```python
MIDDLEWARE = [
    # ... autres middlewares
    'core.middleware.TenantMiddleware',  # AJOUTER ICI
]
```

---

## üìã PHASE 8 : Filtrage Automatique dans les ViewSets

**Fichier** : `backend/academic/views.py`

```python
from rest_framework import viewsets
from django.db.models import Q

class BaseEcoleViewSet(viewsets.ModelViewSet):
    """ViewSet de base avec filtrage automatique par √©cole"""
    
    def get_queryset(self):
        queryset = super().get_queryset()
        
        # Filtrer par √©cole si l'utilisateur est authentifi√©
        if self.request.user.is_authenticated:
            if hasattr(self.request.user, 'ecole') and self.request.user.ecole:
                return queryset.filter(ecole=self.request.user.ecole)
        
        # Si pas d'√©cole, renvoyer vide
        return queryset.none()
    
    def perform_create(self, serializer):
        # Injecter automatiquement l'√©cole
        if hasattr(self.request.user, 'ecole') and self.request.user.ecole:
            serializer.save(ecole=self.request.user.ecole)
        else:
            raise ValidationError("Vous devez √™tre assign√© √† une √©cole")


# Modifier TOUS les ViewSets existants
class EleveViewSet(BaseEcoleViewSet):  # H√©riter de BaseEcoleViewSet
    queryset = Eleve.objects.all()
    serializer_class = EleveSerializer
    # Le reste reste identique !

class ClasseViewSet(BaseEcoleViewSet):  # H√©riter de BaseEcoleViewSet
    queryset = Classe.objects.all()
    serializer_class = ClasseSerializer

# ... R√©p√©ter pour TOUS les ViewSets
```

---

## üìã PHASE 9 : Tests de S√©curit√©

### Test 1 : Isolation des Donn√©es

```python
# backend/test_isolation.py
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
django.setup()

from academic.models import Ecole, Eleve
from users.models import User

# Cr√©er 2 √©coles
ecole_a = Ecole.objects.create(
    code='TEST_A',
    nom='√âcole A',
    directrice='Directrice A',
    adresse='Adresse A',
    telephone='111',
    email='a@test.sn'
)

ecole_b = Ecole.objects.create(
    code='TEST_B',
    nom='√âcole B',
    directrice='Directrice B',
    adresse='Adresse B',
    telephone='222',
    email='b@test.sn'
)

# Cr√©er des √©l√®ves
eleve_a = Eleve.objects.create(nom='Jean', prenom='A', ecole=ecole_a)
eleve_b = Eleve.objects.create(nom='Pierre', prenom='B', ecole=ecole_b)

# Test : Filtrage
eleves_ecole_a = Eleve.objects.filter(ecole=ecole_a)
assert eleve_b not in eleves_ecole_a, "‚ùå √âCHEC : Fuite de donn√©es !"
print("‚úÖ Test d'isolation r√©ussi")

# Nettoyage
ecole_a.delete()
ecole_b.delete()
```

### Ex√©cuter le Test

```bash
python backend/test_isolation.py
```

---

## üìã PHASE 10 : Admin Django

**Fichier** : `backend/academic/admin.py`

```python
from django.contrib import admin
from .models import Ecole

@admin.register(Ecole)
class EcoleAdmin(admin.ModelAdmin):
    list_display = ['nom', 'code', 'directrice', 'abonnement_actif', 'date_creation']
    list_filter = ['abonnement_actif', 'date_creation']
    search_fields = ['nom', 'code', 'directrice']
    readonly_fields = ['date_creation']
```

---

## ‚úÖ Checklist Compl√®te

### Backend
- [ ] Mod√®le Ecole cr√©√© ‚úÖ
- [ ] Champ ecole ajout√© au User
- [ ] Champ ecole ajout√© √† AnneeScolaire
- [ ] Champ ecole ajout√© √† Classe
- [ ] Champ ecole ajout√© √† Matiere
- [ ] Champ ecole ajout√© √† Eleve
- [ ] Champ ecole ajout√© √† Professeur
- [ ] Champ ecole ajout√© √† Periode
- [ ] Migrations cr√©√©es et appliqu√©es
- [ ] √âcole par d√©faut cr√©√©e
- [ ] Donn√©es existantes assign√©es
- [ ] Middleware cr√©√© et activ√©
- [ ] BaseEcoleViewSet cr√©√©
- [ ] Tous les ViewSets modifi√©s
- [ ] Tests de s√©curit√© pass√©s
- [ ] Admin Django configur√©

### Frontend
- [ ] Mise √† jour de l'API (automatique)
- [ ] Page d'administration des √©coles (optionnel)
- [ ] Dashboard super admin (optionnel)

---

## üö® ATTENTION

### Points Critiques
1. ‚ö†Ô∏è **Sauvegarder la DB avant** : `python manage.py dumpdata > backup.json`
2. ‚ö†Ô∏è **Tester en dev** avant de d√©ployer en production
3. ‚ö†Ô∏è **V√©rifier l'isolation** avec les tests
4. ‚ö†Ô∏è **Ne jamais supprimer** le champ ecole une fois en production

### Rollback en Cas de Probl√®me
```bash
python manage.py migrate academic zero
python manage.py migrate users zero
python manage.py loaddata backup.json
```

---

## üéØ R√©sultat Final

Apr√®s ces √©tapes, vous aurez :
- ‚úÖ Une √©cole par d√©faut avec toutes vos donn√©es actuelles
- ‚úÖ Isolation compl√®te des donn√©es par √©cole
- ‚úÖ Syst√®me pr√™t pour le multi-tenant
- ‚úÖ Base solide pour un SaaS

---

## üìû Prochaines √âtapes (Apr√®s Cloisonnement)

1. **Inscription d'√©cole** : Interface pour cr√©er de nouvelles √©coles
2. **S√©lection d'√©cole** : Au login si super admin
3. **Dashboard SaaS** : Vue globale de toutes les √©coles
4. **Syst√®me de paiement** : Stripe/PayPal
5. **Plans tarifaires** : Basic, Pro, Enterprise

---

**üéâ Bonne chance avec l'impl√©mentation !**
