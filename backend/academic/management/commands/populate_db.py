from django.core.management.base import BaseCommand
from django.contrib.auth import get_user_model
from datetime import date, timedelta
from academic.models import AnneeScolaire, Classe, Matiere, Eleve, MatiereClasse
from users.models import Professeur, Admin
from grades.models import Periode, TypeEvaluation
import random

User = get_user_model()


class Command(BaseCommand):
    help = 'Remplit la base de donn√©es avec des donn√©es de test'

    def handle(self, *args, **kwargs):
        self.stdout.write(self.style.SUCCESS('üöÄ D√©marrage du remplissage de la base de donn√©es...'))

        # Nettoyer les donn√©es existantes (optionnel)
        self.stdout.write('üóëÔ∏è  Nettoyage des anciennes donn√©es...')
        Eleve.objects.all().delete()
        MatiereClasse.objects.all().delete()
        Classe.objects.all().delete()
        Matiere.objects.all().delete()
        Professeur.objects.all().delete()
        Admin.objects.all().delete()
        User.objects.filter(is_superuser=False).delete()
        AnneeScolaire.objects.all().delete()

        # 1. Cr√©er une ann√©e scolaire
        self.stdout.write('üìÖ Cr√©ation de l\'ann√©e scolaire...')
        annee_scolaire = AnneeScolaire.objects.create(
            libelle='2024-2025',
            date_debut=date(2024, 9, 1),
            date_fin=date(2025, 6, 30),
            active=True
        )
        self.stdout.write(self.style.SUCCESS(f'   ‚úÖ Ann√©e scolaire cr√©√©e: {annee_scolaire.libelle}'))

        # 1.1 Cr√©er les p√©riodes (trimestres)
        self.stdout.write('üìÖ Cr√©ation des p√©riodes (trimestres)...')
        periodes_data = [
            {'nom': 'trimestre1', 'date_debut': date(2024, 9, 1), 'date_fin': date(2024, 12, 15)},
            {'nom': 'trimestre2', 'date_debut': date(2025, 1, 5), 'date_fin': date(2025, 3, 31)},
            {'nom': 'trimestre3', 'date_debut': date(2025, 4, 1), 'date_fin': date(2025, 6, 30)},
        ]
        
        periodes = []
        for periode_data in periodes_data:
            periode = Periode.objects.create(
                **periode_data,
                annee_scolaire=annee_scolaire,
                est_cloturee=False
            )
            periodes.append(periode)
            self.stdout.write(self.style.SUCCESS(f'   ‚úÖ {periode.get_nom_display()} cr√©√©e'))

        # 1.2 Cr√©er les types d'√©valuation
        self.stdout.write('üìù Cr√©ation des types d\'√©valuation...')
        types_eval_data = [
            {'nom': 'devoir', 'coefficient': 1.0, 'description': '√âvaluations quotidiennes'},
            {'nom': 'controle', 'coefficient': 2.0, 'description': 'Contr√¥les p√©riodiques'},
            {'nom': 'composition', 'coefficient': 3.0, 'description': 'Examens de fin de trimestre'},
        ]
        
        for type_data in types_eval_data:
            type_eval, created = TypeEvaluation.objects.get_or_create(
                nom=type_data['nom'],
                defaults={
                    'coefficient': type_data['coefficient'],
                    'description': type_data['description']
                }
            )
            if created:
                self.stdout.write(self.style.SUCCESS(
                    f'   ‚úÖ {type_eval.get_nom_display()} (Coef: {type_eval.coefficient})'
                ))

        # 2. Cr√©er un administrateur
        self.stdout.write('üë§ Cr√©ation d\'un administrateur...')
        admin_user, created = User.objects.get_or_create(
            username='admin',
            defaults={
                'email': 'admin@ecole.com',
                'first_name': 'Jean',
                'last_name': 'DUPONT',
                'role': 'admin',
                'telephone': '677123456'
            }
        )
        if created:
            admin_user.set_password('admin123')
            admin_user.save()
        else:
            # Si l'utilisateur existe d√©j√†, mettre √† jour son mot de passe
            admin_user.set_password('admin123')
            admin_user.role = 'admin'
            admin_user.save()
        
        # Cr√©er ou r√©cup√©rer le profil Admin
        Admin.objects.get_or_create(user=admin_user, defaults={'fonction': 'Directeur'})
        
        if created:
            self.stdout.write(self.style.SUCCESS('   ‚úÖ Admin cr√©√©: admin / admin123'))
        else:
            self.stdout.write(self.style.SUCCESS('   ‚úÖ Admin existant mis √† jour: admin / admin123'))

        # 3. Cr√©er des professeurs
        self.stdout.write('üë®‚Äçüè´ Cr√©ation des professeurs...')
        professeurs_data = [
            {'prenom': 'Marie', 'nom': 'MARTIN', 'specialite': 'Math√©matiques', 'matricule': 'PROF001'},
            {'prenom': 'Pierre', 'nom': 'BERNARD', 'specialite': 'Fran√ßais', 'matricule': 'PROF002'},
            {'prenom': 'Sophie', 'nom': 'DUBOIS', 'specialite': 'Anglais', 'matricule': 'PROF003'},
            {'prenom': 'Luc', 'nom': 'THOMAS', 'specialite': 'Sciences', 'matricule': 'PROF004'},
            {'prenom': 'Anne', 'nom': 'PETIT', 'specialite': 'Histoire-G√©ographie', 'matricule': 'PROF005'},
        ]
        
        professeurs = []
        for prof_data in professeurs_data:
            user = User.objects.create_user(
                username=prof_data['matricule'].lower(),
                email=f"{prof_data['prenom'].lower()}.{prof_data['nom'].lower()}@ecole.com",
                password='prof123',
                first_name=prof_data['prenom'],
                last_name=prof_data['nom'],
                role='professeur',
                telephone=f'677{random.randint(100000, 999999)}'
            )
            prof = Professeur.objects.create(
                user=user,
                matricule=prof_data['matricule'],
                specialite=prof_data['specialite']
            )
            professeurs.append(prof)
            self.stdout.write(self.style.SUCCESS(f'   ‚úÖ Prof. {prof.user.get_full_name()} - {prof.specialite}'))

        # 4. Cr√©er des mati√®res
        self.stdout.write('üìö Cr√©ation des mati√®res...')
        matieres_data = [
            {'nom': 'Math√©matiques', 'code': 'MATH', 'coefficient': 4.0},
            {'nom': 'Fran√ßais', 'code': 'FR', 'coefficient': 3.0},
            {'nom': 'Anglais', 'code': 'ANG', 'coefficient': 3.0},
            {'nom': 'Histoire-G√©ographie', 'code': 'HIST', 'coefficient': 2.0},
            {'nom': 'Sciences de la Vie et de la Terre', 'code': 'SVT', 'coefficient': 2.0},
            {'nom': 'Physique-Chimie', 'code': 'PC', 'coefficient': 2.0},
            {'nom': '√âducation Physique et Sportive', 'code': 'EPS', 'coefficient': 1.0},
            {'nom': 'Arts Plastiques', 'code': 'ARTS', 'coefficient': 1.0},
        ]
        
        matieres = []
        for mat_data in matieres_data:
            matiere = Matiere.objects.create(**mat_data)
            matieres.append(matiere)
            self.stdout.write(self.style.SUCCESS(f'   ‚úÖ {matiere.nom} (Coef: {matiere.coefficient})'))

        # 5. Cr√©er des classes
        self.stdout.write('üè´ Cr√©ation des classes...')
        classes_data = [
            {'nom': '6√®me A', 'niveau': '6eme', 'effectif_max': 40},
            {'nom': '6√®me B', 'niveau': '6eme', 'effectif_max': 40},
            {'nom': '5√®me A', 'niveau': '5eme', 'effectif_max': 38},
            {'nom': '5√®me B', 'niveau': '5eme', 'effectif_max': 38},
            {'nom': '4√®me A', 'niveau': '4eme', 'effectif_max': 35},
            {'nom': '3√®me A', 'niveau': '3eme', 'effectif_max': 35},
        ]
        
        classes = []
        for i, classe_data in enumerate(classes_data):
            classe = Classe.objects.create(
                **classe_data,
                annee_scolaire=annee_scolaire,
                professeur_principal=professeurs[i % len(professeurs)]
            )
            classes.append(classe)
            
            # Assigner des mati√®res √† la classe
            for matiere in matieres:
                MatiereClasse.objects.create(
                    classe=classe,
                    matiere=matiere,
                    professeur=professeurs[random.randint(0, len(professeurs)-1)]
                )
            
            self.stdout.write(self.style.SUCCESS(
                f'   ‚úÖ {classe.nom} - Prof. Principal: {classe.professeur_principal.user.get_full_name()}'
            ))

        # 6. Cr√©er des √©l√®ves
        self.stdout.write('üë• Cr√©ation des √©l√®ves...')
        
        prenoms_garcons = [
            'Jean', 'Pierre', 'Luc', 'Marc', 'Paul', 'Thomas', 'Nicolas', 'Alexandre',
            'Maxime', 'Lucas', 'Hugo', 'Louis', 'Gabriel', 'Arthur', 'Mathis', 'Nathan'
        ]
        
        prenoms_filles = [
            'Marie', 'Sophie', 'Anne', 'Julie', 'Camille', 'Emma', 'L√©a', 'Chlo√©',
            'Sarah', 'Laura', 'Manon', 'Clara', 'Lucie', 'Oc√©ane', 'Jade', 'Lisa'
        ]
        
        noms = [
            'MARTIN', 'BERNARD', 'DUBOIS', 'THOMAS', 'ROBERT', 'PETIT', 'DURAND', 'LEROY',
            'MOREAU', 'SIMON', 'LAURENT', 'LEFEBVRE', 'MICHEL', 'GARCIA', 'DAVID', 'BERTRAND',
            'ROUX', 'VINCENT', 'FOURNIER', 'MOREL', 'GIRARD', 'ANDRE', 'LEFEBVRE', 'MERCIER'
        ]
        
        villes = ['Yaound√©', 'Douala', 'Bafoussam', 'Garoua', 'Bamenda', 'Maroua', 'Ngaound√©r√©']
        
        total_eleves = 0
        for classe in classes:
            # Nombre d'√©l√®ves par classe (80-90% de l'effectif max)
            nb_eleves = int(classe.effectif_max * random.uniform(0.8, 0.9))
            
            for i in range(nb_eleves):
                sexe = random.choice(['M', 'F'])
                prenom = random.choice(prenoms_garcons if sexe == 'M' else prenoms_filles)
                nom = random.choice(noms)
                
                # Date de naissance en fonction du niveau
                niveau_map = {
                    '6eme': (2012, 2013),
                    '5eme': (2011, 2012),
                    '4eme': (2010, 2011),
                    '3eme': (2009, 2010),
                }
                annee_min, annee_max = niveau_map.get(classe.niveau, (2012, 2013))
                annee_naissance = random.randint(annee_min, annee_max)
                mois_naissance = random.randint(1, 12)
                jour_naissance = random.randint(1, 28)
                
                eleve = Eleve.objects.create(
                    matricule=f'EL{total_eleves + 1:05d}',
                    nom=nom,
                    prenom=prenom,
                    sexe=sexe,
                    date_naissance=date(annee_naissance, mois_naissance, jour_naissance),
                    lieu_naissance=random.choice(villes),
                    telephone_eleve=f'6{random.randint(70000000, 79999999)}' if random.random() > 0.5 else '',
                    email=f'{prenom.lower()}.{nom.lower()}@eleve.com' if random.random() > 0.6 else '',
                    adresse=f'{random.randint(1, 500)} Rue {random.choice(["des Fleurs", "de la Paix", "du March√©", "Principale"])}',
                    nom_pere=f'{random.choice(prenoms_garcons)} {nom}',
                    telephone_pere=f'6{random.randint(70000000, 79999999)}',
                    nom_mere=f'{random.choice(prenoms_filles)} {random.choice(noms)}',
                    telephone_mere=f'6{random.randint(70000000, 79999999)}',
                    classe=classe,
                    statut='actif'
                )
                total_eleves += 1
            
            self.stdout.write(self.style.SUCCESS(
                f'   ‚úÖ {nb_eleves} √©l√®ves ajout√©s dans {classe.nom}'
            ))

        # R√©sum√©
        self.stdout.write('\n' + '='*60)
        self.stdout.write(self.style.SUCCESS('üéâ BASE DE DONN√âES REMPLIE AVEC SUCC√àS !'))
        self.stdout.write('='*60)
        self.stdout.write(f'üìä R√âSUM√â:')
        self.stdout.write(f'   ‚Ä¢ Ann√©es scolaires: {AnneeScolaire.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ P√©riodes (trimestres): {Periode.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ Types d\'√©valuation: {TypeEvaluation.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ Administrateurs: {Admin.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ Enseignants: {Professeur.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ Mati√®res: {Matiere.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ Classes: {Classe.objects.count()}')
        self.stdout.write(f'   ‚Ä¢ √âl√®ves: {Eleve.objects.count()}')
        self.stdout.write('\n' + '='*60)
        self.stdout.write('üîë IDENTIFIANTS DE CONNEXION:')
        self.stdout.write('='*60)
        self.stdout.write(self.style.SUCCESS('   üë§ Admin:'))
        self.stdout.write('      Username: admin')
        self.stdout.write('      Password: admin123')
        self.stdout.write('')
        self.stdout.write(self.style.SUCCESS('   üë®‚Äçüè´ Professeurs (tous):'))
        self.stdout.write('      Username: prof001, prof002, prof003, prof004, prof005')
        self.stdout.write('      Password: prof123')
        self.stdout.write('='*60)
